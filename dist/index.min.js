!function(a,b){"function"==typeof define&&define.amd?define(["jquery","backbone","underscore"],b):"object"==typeof module&&module.exports?module.exports=b(require("jquery"),require("backbone"),require("underscore")):a.backboneJsonApi=b(a.jQuery,a.Backbone,a._)}(this,function(a,b,c){var d,e,f;return f=b.Collection.extend({modelId:function(a){return a._type+"@"+a.id},retrieve:function(a,b){var c=this.find(function(c){return c.getType()===a&&c.get("id")===b});return c&&!c.includedCollection&&(c.includedCollection=this.clone()),c}}),e=b.Model.extend({constructor:function(a,c,d){this.apiData={data:{},included:[]},this.includedArray=[],a=a||{},a.id&&(this.apiData.data.id=a.id),this.type&&(this.apiData.data.type=this.type),a._type&&(this.apiData.data.type=a._type);var e=this.initialize;this.initialize=function(){},b.Model.call(this,a,c),d&&d.call(this,this),e.apply(this,arguments)},getType:function(){return this.apiData.data.type},setType:function(a){return this.apiData.data.type=a,this},buildIncludedCollection:function(){if(!this.includedCollection){var a=c.map(this.includedArray,function(a){var b=e.createFromData({data:a},{assignIncludes:!1});return b.includedArray=this.includedArray,b},this);this.includedCollection=new f([this].concat(a)),this.sourceCollection&&this.sourceCollection.each(function(a){a.includedCollection=this.includedCollection.clone()},this)}return this},get:function(a){var e,f=c.isArray(a)?a:a.split("."),g=f[0];if(this.apiData.data.relationships&&this.apiData.data.relationships[g]){if(void 0!==(e=this.getRelation(g))){if(2===f.length&&e instanceof d)return e.pluck(f[1]);if(f.length>1)return f.shift(),e.get(f)}}else e=b.Model.prototype.get.call(this,g);return e},getRelation:function(a){var b=this.apiData.data.relationships[a],e=b&&b.data;return e?c.isArray(e)?(this.buildIncludedCollection(),new d(c.map(e,function(a){return this.includedCollection.retrieve(a.type,a.id)},this))):(this.buildIncludedCollection(),this.includedCollection.retrieve(e.type,e.id)):void 0},getRelationReferences:function(a){if(this.apiData.data.relationships&&this.apiData.data.relationships[a]){var b=this.apiData.data.relationships[a].data;return c.isArray(b)?b.length?c.pluck(b,"id"):void 0:b&&b.id?b.id:void 0}},setRelation:function(a,b){var f=this.apiData.data;return f.relationships=f.relationships||{},this.buildIncludedCollection(),c.each(c.isObject(a)?a:c.object([a],[b]),function(a,b){a instanceof e?(a={type:a.getType(),id:a.get("id")},this.includedCollection.add(a,{merge:!0})):a instanceof d&&(a=a.map(function(a){return{type:a.getType(),id:a.get("id")}}),this.includedCollection.add(a.models,{merge:!0})),f.relationships[b]=f.relationships[b]||{},f.relationships[b].data=a},this),this},saveOnly:function(a){var b,d=this,e=this.preparePersistedKeys(a);return a.relations&&!c.isArray(a.relations)&&this.setRelation(a.relations),b=this.save(c.isArray(a.attributes)?null:a.attributes,e),a.afterSave&&b.done(function(){a.afterSave(d)}),b},saveAttribute:function(a,b){return void 0!==b&&this.set(a,b),this.saveOnly({attributes:[a]})},saveRelation:function(a,b){return b&&this.setRelation(a,b),this.saveOnly({relations:[a]})},preparePersistedKeys:function(a){var b={};return a.attributes?b.persistedAttributes=c.isArray(a.attributes)?a.attributes:c.keys(a.attributes):b.persistedAttributes=[],a.relations?c.isArray(a.relations)?b.persistedRelations=a.relations:b.persistedRelations=c.keys(a.relations):b.persistedRelations=[],b},prepareSyncData:function(a){var b=c.extend({},c.pick(this.apiData.data,["type","id"])),d=this.persistedAttributes||a.persistedAttributes,e=d?c.pick(this.attributes,d):this.attributes;e=c.omit(e,["id","_type"]),c.isEmpty(e)||(b.attributes=e);var f=this.persistedRelations||a.persistedRelations,g=f?c.pick(this.apiData.data.relationships,f):this.apiData.data.relationships;return c.isEmpty(g)||(b.relationships=g),b},sync:function(b,d,e){var f={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"},g={type:f[b],dataType:"json",url:c.result(d,"url")};e.data||!d||"create"!==b&&"update"!==b&&"patch"!==b||c.extend(g,{contentType:"application/vnd.api+json",data:JSON.stringify({data:this.prepareSyncData(e)})});var h=e.xhr=a.ajax(c.extend(g,e));return d.trigger("request",d,h,e),h},urlRoot:function(){return"/api/"+this.getType()},parse:function(a,b){c.extend(this.apiData,a);var d=a.data.attributes||{};return a.data.id&&(d.id=a.data.id),a.data.type&&(d._type=a.data.type),delete this.includedCollection,this.includedArray=[a.data].concat(a.included||[]),d}},{apiUrl:function(a,b){return"/api/"+a+(b?"/"+b:"")},getType:function(){return this.prototype.type},getFromApi:function(b,d,e){b=c.extend({resourceName:this.type},b);var f=this,g=b.resourceName||b.type||f.getType(),h=b.url||f.apiUrl(g,b.id),i=a.Deferred();return a.get(h,function(a){var b=f.createFromData(a);d&&d.call(e||this,b,a),i.resolve(b)}).fail(function(a){i.reject(a)}),i},createFromData:function(a,b){a.data=a.data||{},b=c.extend({assignIncludes:!0},b);var d=this,e=a.data.attributes||{};return a.data.id&&(e.id=a.data.id),a.data.type&&(e._type=a.data.type),new d(e,b,function(d){c.extend(d.apiData,a),b.assignIncludes&&(d.includedArray=[a.data].concat(a.included||[]))})},create:function(a,b){return new this(a,b)}}),d=b.Collection.extend({fetch:function(){return d.getFromApi({url:this.url||this.apiUrl},function(a){this.set(a.models)},this)}},{apiUrl:function(a,b){return"/api/"+a},getFromApi:function(b,c,d){"string"==typeof b&&(b={resourceName:b});var e=this,f=b.url||e.apiUrl(b.resourceName||b.type,b),g=a.Deferred();return a.get(f,function(a){var h=e.createFromData(a,b);h.apiUrl=f,c&&c.call(d||this,h,a),g.resolve(h)}).fail(function(a){g.reject(a)}),g},createFromData:function(a,b){var d=this,f=b&&b.Model||e,g=a.data.concat(a.included||[]),h=c.map(a.data,function(a){var b=f.createFromData({data:a},{assignIncludes:!1});return b.includedArray=g,b}),i=new d(h,b);return i.each(function(a){a.sourceCollection=i}),i.apiData=a,i}}),{Model:e,Collection:d}});