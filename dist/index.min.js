!function(t,e){"function"==typeof define&&define.amd?define(["jquery","backbone","underscore"],e):"object"==typeof module&&module.exports?module.exports=e(require("jquery"),require("backbone"),require("underscore")):t.backboneJsonApi=e(t.jQuery,t.Backbone,t._)}(this,function(t,e,i){var a,n,r;return r=e.Collection.extend({modelId:function(t){return t._type+"@"+t.id},retrieve:function(t,e){var i=this.find(function(i){return i.getType()===t&&i.get("id")===e});return i&&!i.includedCollection&&(i.includedCollection=this.clone()),i}}),n=e.Model.extend({constructor:function(t,i,a){this.apiData={data:{},included:[]},this.includedArray=[],(t=t||{}).id&&(this.apiData.data.id=t.id),this.type&&(this.apiData.data.type=this.type),t._type&&(this.apiData.data.type=t._type);var n=this.initialize;this.initialize=function(){},e.Model.call(this,t,i),a&&a.call(this,this),n.apply(this,arguments)},getType:function(){return this.apiData.data.type},setType:function(t){return this.apiData.data.type=t,this},buildIncludedCollection:function(){if(!this.includedCollection){var t=i.map(this.includedArray,function(t){var e=n.createFromData({data:t},{assignIncludes:!1});return e.includedArray=this.includedArray,e},this);this.includedCollection=new r([this].concat(t)),this.sourceCollection&&this.sourceCollection.each(function(t){t.includedCollection=this.includedCollection.clone()},this)}return this},get:function(t){var n,r=i.isArray(t)?t:t.split("."),s=r[0];if(this.apiData.data.relationships&&this.apiData.data.relationships[s]){if(void 0!==(n=this.getRelation(s))){if(2===r.length&&n instanceof a)return n.pluck(r[1]);if(r.length>1)return r.shift(),n.get(r)}}else n=e.Model.prototype.get.call(this,s);return n},getRelation:function(t){var e=this.apiData.data.relationships[t],n=e&&e.data;return n?i.isArray(n)?(this.buildIncludedCollection(),new a(i.map(n,function(t){return this.includedCollection.retrieve(t.type,t.id)},this))):(this.buildIncludedCollection(),this.includedCollection.retrieve(n.type,n.id)):void 0},getRelationReferences:function(t){if(this.apiData.data.relationships&&this.apiData.data.relationships[t]){var e=this.apiData.data.relationships[t].data;return i.isArray(e)?e.length?i.pluck(e,"id"):void 0:e&&e.id?e.id:void 0}},setRelation:function(t,e){var r=this.apiData.data;return r.relationships=r.relationships||{},this.buildIncludedCollection(),i.each(i.isObject(t)?t:i.object([t],[e]),function(t,e){t instanceof n?(t={type:t.getType(),id:t.get("id")},this.includedCollection.add(t,{merge:!0})):t instanceof a&&(t=t.map(function(t){return{type:t.getType(),id:t.get("id")}}),this.includedCollection.add(t.models,{merge:!0})),r.relationships[e]=r.relationships[e]||{},r.relationships[e].data=t},this),this},saveOnly:function(t){var e,a=this,n=this.preparePersistedKeys(t);return t.relations&&!i.isArray(t.relations)&&this.setRelation(t.relations),t.files&&(n.files=t.files),e=this.save(i.isArray(t.attributes)?null:t.attributes,n),t.afterSave&&e.done(function(){t.afterSave(a)}),e},saveAttribute:function(t,e){return void 0!==e&&this.set(t,e),this.saveOnly({attributes:[t]})},saveFile:function(t,e){if(void 0!==e){var i={};i[t]=e}else i=t;return this.saveOnly({files:i})},saveRelation:function(t,e){return e&&this.setRelation(t,e),this.saveOnly({relations:[t]})},preparePersistedKeys:function(t){var e={};return t.attributes?e.persistedAttributes=i.isArray(t.attributes)?t.attributes:i.keys(t.attributes):e.persistedAttributes=[],t.relations?i.isArray(t.relations)?e.persistedRelations=t.relations:e.persistedRelations=i.keys(t.relations):e.persistedRelations=[],e},prepareSyncData:function(t){var e=i.extend({},i.pick(this.apiData.data,["type","id"])),a=this.persistedAttributes||t.persistedAttributes,n=a?i.pick(this.attributes,a):this.attributes;n=i.omit(n,["id","_type"]),i.isEmpty(n)||(e.attributes=n);var r=this.persistedRelations||t.persistedRelations,s=r?i.pick(this.apiData.data.relationships,r):this.apiData.data.relationships;return i.isEmpty(s)||(e.relationships=s),t.files&&!i.isEmpty(t.files)&&(e.files=t.files),e},sync:function(e,a,n){var r={type:{create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"}[e],dataType:"json",url:i.result(a,"url"),processData:!1};if(!n.data&&a&&("create"===e||"update"===e||"patch"===e)){var s=this.prepareSyncData(n);if(s.files){var o=new FormData;o.append("data",JSON.stringify(i.omit(s,"files"))),i.each(s.files,function(t,e){o.append(e,t)}),i.extend(r,{contentType:!1,data:o})}else i.extend(r,{contentType:"application/vnd.api+json",data:JSON.stringify({data:s})})}var d=n.xhr=t.ajax(i.extend(r,n));return a.trigger("request",a,d,n),d},urlRoot:function(){return"/api/"+this.getType()},parse:function(t,e){i.extend(this.apiData,t);var a=t.data.attributes||{};return t.data.id&&(a.id=t.data.id),t.data.type&&(a._type=t.data.type),delete this.includedCollection,this.includedArray=[t.data].concat(t.included||[]),a}},{apiUrl:function(t,e){return"/api/"+t+(e?"/"+e:"")},getType:function(){return this.prototype.type},getFromApi:function(e,a,n){var r=this,s=(e=i.extend({resourceName:this.type},e)).resourceName||e.type||r.getType(),o=e.url||r.apiUrl(s,e.id),d=t.Deferred();return t.get(o,function(t){var e=r.createFromData(t);a&&a.call(n||this,e,t),d.resolve(e)}).fail(function(t){d.reject(t)}),d},createFromData:function(t,e){t.data=t.data||{},e=i.extend({assignIncludes:!0},e);var a=this,n=t.data.attributes||{};return t.data.id&&(n.id=t.data.id),t.data.type&&(n._type=t.data.type),new a(n,e,function(a){i.extend(a.apiData,t),e.assignIncludes&&(a.includedArray=[t.data].concat(t.included||[]))})},create:function(t,e){return new this(t,e)}}),a=e.Collection.extend({fetch:function(){return a.getFromApi({url:this.url||this.apiUrl},function(t){this.set(t.models)},this)}},{apiUrl:function(t,e){return"/api/"+t},getFromApi:function(e,i,a){"string"==typeof e&&(e={resourceName:e});var n=this,r=e.url||n.apiUrl(e.resourceName||e.type,e),s=t.Deferred();return t.get(r,function(t){var o=n.createFromData(t,e);o.apiUrl=r,i&&i.call(a||this,o,t),s.resolve(o)}).fail(function(t){s.reject(t)}),s},createFromData:function(t,e){var a=this,r=e&&e.Model||n,s=t.data.concat(t.included||[]),o=new a(i.map(t.data,function(t){var e=r.createFromData({data:t},{assignIncludes:!1});return e.includedArray=s,e}),e);return o.each(function(t){t.sourceCollection=o}),o.apiData=t,o}}),{Model:n,Collection:a}});